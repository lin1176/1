import os
import re
import time
import random
import threading
import queue
import json
import requests
import pickle
import tkinter as tk
from tkinter import scrolledtext, messagebox, ttk
from collections import defaultdict, Counter
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from selenium.webdriver.common.action_chains import ActionChains
import keyboard

# ä¿®å¤jiebaå¯¼å…¥é—®é¢˜
try:
    import jieba
    import jieba.analyse

    if not hasattr(jieba, 'lcut'):
        jieba.lcut = lambda text: list(jieba.cut(text))
except ImportError:
    class MockJieba:
        @staticmethod
        def lcut(text):
            return [char for char in text if len(char.strip()) > 0]


    jieba = MockJieba()


# ==================== èŠå¤©è®°å½•æ·±åº¦å­¦ä¹ å™¨ ====================
class ChatRecordLearner:
    """ä»çœŸå®èŠå¤©è®°å½•ä¸­æ·±åº¦å­¦ä¹ """

    def __init__(self, tex_dir):
        self.tex_dir = tex_dir
        self.conversations = []
        self.my_responses = []
        self.qa_pairs = []
        self.learned_patterns = {}

    def learn_from_chat_records(self):
        """ä»èŠå¤©è®°å½•ä¸­å­¦ä¹ """
        print("ğŸ“ å¼€å§‹æ·±åº¦å­¦ä¹ èŠå¤©è®°å½•...")

        if not os.path.exists(self.tex_dir):
            print(f"âš ï¸ ç›®å½•ä¸å­˜åœ¨: {self.tex_dir}")
            return self._get_default_learning()

        tex_files = [f for f in os.listdir(self.tex_dir) if f.endswith('.tex')]
        if not tex_files:
            print(f"âš ï¸ æœªæ‰¾åˆ°.texæ–‡ä»¶")
            return self._get_default_learning()

        print(f"ğŸ“ å‘ç° {len(tex_files)} ä¸ªèŠå¤©æ–‡ä»¶")

        # 1. æå–æ‰€æœ‰å¯¹è¯
        self._extract_all_conversations(tex_files)

        # 2. åˆ†ææˆ‘çš„å›å¤é£æ ¼
        self._analyze_my_response_style()

        # 3. å­¦ä¹ é—®ç­”æ¨¡å¼
        self._learn_qa_patterns()

        # 4. å­¦ä¹ ä¸šåŠ¡æµç¨‹
        self._learn_business_processes()

        # 5. å­¦ä¹ å®šä»·è§„åˆ™
        self._learn_pricing_rules()

        print(f"âœ… å­¦ä¹ å®Œæˆ: {len(self.conversations)}ä¸ªå¯¹è¯, {len(self.qa_pairs)}ä¸ªé—®ç­”å¯¹")
        return self.learned_patterns

    def _extract_all_conversations(self, tex_files):
        """æå–æ‰€æœ‰å¯¹è¯"""
        for filename in tex_files:
            filepath = os.path.join(self.tex_dir, filename)
            try:
                with open(filepath, 'r', encoding='utf-8') as f:
                    content = f.read()

                lines = content.split('\n')
                current_conversation = []

                for line in lines:
                    line = line.strip()
                    if line.startswith('æˆ‘ï¼š') or line.startswith('å®¢æˆ·ï¼š'):
                        role = 'æˆ‘' if line.startswith('æˆ‘ï¼š') else 'å®¢æˆ·'
                        message = line[2:].strip()

                        if message and len(message) > 1:
                            current_conversation.append({
                                'role': role,
                                'message': message,
                                'file': filename
                            })

                            if role == 'æˆ‘':
                                self.my_responses.append(message)

                if len(current_conversation) >= 2:
                    self.conversations.append(current_conversation)

            except Exception as e:
                print(f"âŒ å¤„ç†æ–‡ä»¶ {filename} å‡ºé”™: {e}")

    def _analyze_my_response_style(self):
        """åˆ†ææˆ‘çš„å›å¤é£æ ¼"""
        if not self.my_responses:
            self.learned_patterns['response_style'] = self._get_default_style()
            return

        print(f"ğŸ­ åˆ†æ {len(self.my_responses)} æ¡å›å¤çš„é£æ ¼...")

        # åˆ†æè¯­è¨€ç‰¹ç‚¹
        style_analysis = {
            'avg_length': sum(len(resp) for resp in self.my_responses) / len(self.my_responses),
            'common_openings': self._get_common_patterns([resp[:2] for resp in self.my_responses if len(resp) >= 2]),
            'common_endings': self._get_common_patterns([resp[-2:] for resp in self.my_responses if len(resp) >= 2]),
            'tone_words': self._extract_tone_words(),
            'question_style': self._analyze_question_style(),
            'punctuation_usage': self._analyze_punctuation(),
            'address_style': self._analyze_address_style(),
            'enthusiasm_level': self._analyze_enthusiasm_level()
        }

        self.learned_patterns['response_style'] = style_analysis
        print(f"ğŸ“Š é£æ ¼ç‰¹ç‚¹: å¹³å‡{style_analysis['avg_length']:.1f}å­—, è¯­æ°”è¯{len(style_analysis['tone_words'])}ä¸ª")

    def _learn_qa_patterns(self):
        """å­¦ä¹ é—®ç­”æ¨¡å¼"""
        print("ğŸ¤” å­¦ä¹ é—®ç­”æ¨¡å¼...")

        qa_patterns = defaultdict(list)

        for conv in self.conversations:
            for i in range(len(conv) - 1):
                if conv[i]['role'] == 'å®¢æˆ·' and conv[i + 1]['role'] == 'æˆ‘':
                    customer_msg = conv[i]['message']
                    my_response = conv[i + 1]['message']

                    # åˆ†ç±»å®¢æˆ·é—®é¢˜ç±»å‹
                    question_type = self._classify_customer_question(customer_msg)

                    qa_patterns[question_type].append({
                        'customer': customer_msg,
                        'response': my_response,
                        'context': self._get_conversation_context(conv, i)
                    })

                    self.qa_pairs.append({
                        'customer': customer_msg,
                        'response': my_response,
                        'type': question_type
                    })

        self.learned_patterns['qa_patterns'] = dict(qa_patterns)
        print(f"ğŸ“ å­¦åˆ° {len(qa_patterns)} ç§é—®é¢˜ç±»å‹çš„å›å¤æ¨¡å¼")

    def _learn_business_processes(self):
        """å­¦ä¹ ä¸šåŠ¡æµç¨‹"""
        print("ğŸ’¼ å­¦ä¹ ä¸šåŠ¡æµç¨‹...")

        business_processes = {
            'questionnaire_design_flow': self._extract_questionnaire_flow(),
            'data_analysis_flow': self._extract_data_analysis_flow(),
            'pricing_flow': self._extract_pricing_flow(),
            'requirement_collection': self._extract_requirement_collection(),
            'payment_flow': self._extract_payment_flow()
        }

        self.learned_patterns['business_processes'] = business_processes
        print("ğŸ“‹ å­¦ä¹ äº†é—®å·è®¾è®¡ã€æ•°æ®åˆ†æã€å®šä»·ã€ä»˜æ¬¾ç­‰ä¸šåŠ¡æµç¨‹")

    def _learn_pricing_rules(self):
        """å­¦ä¹ å®šä»·è§„åˆ™"""
        print("ğŸ’° å­¦ä¹ å®šä»·è§„åˆ™...")

        pricing_rules = {
            'questionnaire_pricing': self._extract_unified_pricing('é—®å·'),
            'data_analysis_pricing': self._extract_unified_pricing('åˆ†æ'),
            'data_fill_pricing': self._extract_unified_pricing('ä»£å¡«'),
            'optimization_pricing': self._extract_unified_pricing('ä¼˜åŒ–')
        }

        self.learned_patterns['pricing_rules'] = pricing_rules
        print("ğŸ’³ å­¦ä¹ äº†å„ç§æœåŠ¡çš„å®šä»·è§„åˆ™")

    def _extract_unified_pricing(self, service_type):
        """ç»Ÿä¸€çš„å®šä»·æå–æ–¹æ³•"""
        pricing_responses = []

        for resp in self.my_responses:
            if service_type in resp and 'å…ƒ' in resp:
                pricing_responses.append(resp)

        if service_type == 'é—®å·':
            pricing_rules = {
                'base_pricing': '0-10é¢˜18å…ƒ',
                'increment_rule': 'æ¯å¢10é¢˜+18å…ƒ',
                'examples': pricing_responses[:5]
            }
        elif service_type == 'åˆ†æ':
            pricing_rules = {
                'pricing_examples': pricing_responses[:10],
                'typical_prices': {
                    'æè¿°æ€§ç»Ÿè®¡': '25å…ƒ',
                    'ä¿¡åº¦åˆ†æ': '28å…ƒ',
                    'æ•ˆåº¦åˆ†æ': '28å…ƒ',
                    'Tæ£€éªŒ': '40å…ƒ',
                    'ç›¸å…³æ€§åˆ†æ': '40å…ƒ',
                    'æ–¹å·®åˆ†æ': '55å…ƒ',
                    'å› å­åˆ†æ': '55å…ƒ',
                    'èšç±»åˆ†æ': '55å…ƒ',
                    'å›å½’åˆ†æ': '60å…ƒ',
                    'å¡æ–¹æ£€éªŒ': '70å…ƒ',
                    'ä¸­ä»‹æ•ˆåº”': '90å…ƒ'
                }
            }
        elif service_type == 'ä»£å¡«':
            pricing_rules = {
                'pricing_examples': pricing_responses[:5],
                'typical_rates': {
                    'æœºå¡«': '0.35å…ƒ/ä»½',
                    'äººå·¥': '0.5å…ƒ/ä»½',
                    'æŒ‡å®šIP': '0.6å…ƒ/ä»½'
                }
            }
        else:  # ä¼˜åŒ–
            pricing_rules = {
                'pricing_examples': pricing_responses[:3],
                'base_price': '60å…ƒèµ·æ­¥'
            }

        return pricing_rules

    def _get_common_patterns(self, items):
        """è·å–å¸¸è§æ¨¡å¼"""
        counter = Counter(items)
        return dict(counter.most_common(10))

    def _extract_tone_words(self):
        """æå–è¯­æ°”è¯"""
        tone_words = ['å¥½çš„', 'å¯ä»¥', 'è¡Œ', 'å—¯', 'æ˜¯çš„', 'å¯¹', 'æ²¡é—®é¢˜', 'æ”¶åˆ°']
        usage = {}

        for word in tone_words:
            count = sum(1 for resp in self.my_responses if word in resp)
            if count > 0:
                usage[word] = count / len(self.my_responses)

        return usage

    def _analyze_question_style(self):
        """åˆ†ææé—®é£æ ¼"""
        questions = [resp for resp in self.my_responses if 'ï¼Ÿ' in resp or 'å—' in resp]

        if not questions:
            return {'style': 'direct', 'examples': []}

        return {
            'style': 'questioning',
            'frequency': len(questions) / len(self.my_responses),
            'examples': questions[:5]
        }

    def _analyze_punctuation(self):
        """åˆ†ææ ‡ç‚¹ä½¿ç”¨"""
        total_chars = sum(len(resp) for resp in self.my_responses)
        punctuation_count = sum(1 for resp in self.my_responses for char in resp if char in 'ã€‚ï¼ï¼Ÿï¼Œ')

        return {
            'usage_rate': punctuation_count / total_chars if total_chars > 0 else 0,
            'prefers_period': sum(1 for resp in self.my_responses if 'ã€‚' in resp) > 0,
            'uses_exclamation': sum(1 for resp in self.my_responses if 'ï¼' in resp) > 0
        }

    def _analyze_address_style(self):
        """åˆ†æç§°å‘¼é£æ ¼"""
        nin_count = sum(1 for resp in self.my_responses if 'æ‚¨' in resp)
        ni_count = sum(1 for resp in self.my_responses if 'ä½ ' in resp and 'æ‚¨' not in resp)

        if nin_count > ni_count:
            return {'style': 'formal', 'preference': 'æ‚¨'}
        else:
            return {'style': 'casual', 'preference': 'ä½ '}

    def _analyze_enthusiasm_level(self):
        """åˆ†æçƒ­æƒ…ç¨‹åº¦"""
        enthusiasm_indicators = ['å“ˆ', 'å‘¢', '~', 'ï¼', 'ğŸ‘', 'ğŸ˜Š']
        total_indicators = sum(1 for resp in self.my_responses
                               for indicator in enthusiasm_indicators if indicator in resp)

        enthusiasm_rate = total_indicators / len(self.my_responses) if self.my_responses else 0

        if enthusiasm_rate > 0.3:
            return {'level': 'high', 'rate': enthusiasm_rate}
        elif enthusiasm_rate > 0.1:
            return {'level': 'medium', 'rate': enthusiasm_rate}
        else:
            return {'level': 'low', 'rate': enthusiasm_rate}

    def _classify_customer_question(self, message):
        """åˆ†ç±»å®¢æˆ·é—®é¢˜"""
        msg_lower = message.lower()

        if any(word in msg_lower for word in ['è®¾è®¡', 'åšé—®å·', 'ç¼–åˆ¶']):
            return 'é—®å·è®¾è®¡å’¨è¯¢'
        elif any(word in msg_lower for word in ['æ•°æ®åˆ†æ', 'spss', 'åˆ†æ']):
            return 'æ•°æ®åˆ†æå’¨è¯¢'
        elif any(word in msg_lower for word in ['ä»£å¡«', 'é—®å·æ˜Ÿ', 'å¡«å†™']):
            return 'ä»£å¡«æœåŠ¡å’¨è¯¢'
        elif any(word in msg_lower for word in ['å¤šå°‘é’±', 'ä»·æ ¼', 'è´¹ç”¨']):
            return 'ä»·æ ¼å’¨è¯¢'
        elif any(word in msg_lower for word in ['æ—¶é—´', 'å¤šä¹…', 'å‡ å¤©']):
            return 'æ—¶é—´å’¨è¯¢'
        elif any(word in msg_lower for word in ['å”®å', 'ä¿®æ”¹', 'ä¿éšœ']):
            return 'å”®åå’¨è¯¢'
        elif any(word in msg_lower for word in ['ä½ å¥½', 'åœ¨å—', 'å’¨è¯¢']):
            return 'é—®å€™'
        else:
            return 'å…¶ä»–å’¨è¯¢'

    def _get_conversation_context(self, conversation, current_index):
        """è·å–å¯¹è¯ä¸Šä¸‹æ–‡"""
        start_index = max(0, current_index - 2)
        context = []

        for i in range(start_index, current_index):
            context.append(f"{conversation[i]['role']}: {conversation[i]['message']}")

        return " | ".join(context)

    def _extract_questionnaire_flow(self):
        """æå–é—®å·è®¾è®¡æµç¨‹"""
        questionnaire_conversations = []

        for conv in self.conversations:
            if any('é—®å·' in msg['message'] or 'è®¾è®¡' in msg['message'] for msg in conv):
                questionnaire_conversations.append(conv)

        # åˆ†ææµç¨‹æ¨¡å¼
        flow_patterns = []
        for conv in questionnaire_conversations[:5]:  # å–å‰5ä¸ªåˆ†æ
            flow = []
            for msg in conv:
                if msg['role'] == 'æˆ‘':
                    flow.append(msg['message'][:30] + '...' if len(msg['message']) > 30 else msg['message'])
            flow_patterns.append(flow)

        return {
            'typical_flows': flow_patterns,
            'common_questions': self._extract_common_questions_from_flows(questionnaire_conversations)
        }

    def _extract_data_analysis_flow(self):
        """æå–æ•°æ®åˆ†ææµç¨‹"""
        analysis_conversations = []

        for conv in self.conversations:
            if any('åˆ†æ' in msg['message'] or 'spss' in msg['message'].lower() for msg in conv):
                analysis_conversations.append(conv)

        return {
            'pricing_responses': self._extract_pricing_responses(analysis_conversations),
            'service_descriptions': self._extract_service_descriptions(analysis_conversations)
        }

    def _extract_pricing_flow(self):
        """æå–å®šä»·æµç¨‹"""
        pricing_conversations = []

        for conv in self.conversations:
            if any('å¤šå°‘é’±' in msg['message'] or 'ä»·æ ¼' in msg['message'] for msg in conv):
                pricing_conversations.append(conv)

        return {
            'pricing_responses': [msg['message'] for conv in pricing_conversations
                                  for msg in conv if msg['role'] == 'æˆ‘' and ('å…ƒ' in msg['message'])]
        }

    def _extract_requirement_collection(self):
        """æå–éœ€æ±‚æ”¶é›†æ¨¡å¼"""
        requirement_patterns = []

        for resp in self.my_responses:
            if 'éœ€è¦' in resp and 'äº†è§£' in resp:
                requirement_patterns.append(resp)
            elif 'å¡«å†™' in resp and 'ä¿¡æ¯' in resp:
                requirement_patterns.append(resp)

        return {
            'collection_phrases': requirement_patterns[:10],
            'information_requests': self._extract_information_requests()
        }

    def _extract_payment_flow(self):
        """æå–ä»˜æ¬¾æµç¨‹"""
        payment_responses = []

        for resp in self.my_responses:
            if any(word in resp for word in ['æ‹ä¸‹', 'ä»˜æ¬¾', 'æ”¹ä»·', 'å³ä¸Šæ–¹']):
                payment_responses.append(resp)

        return {
            'payment_phrases': payment_responses[:10],
            'typical_payment_guide': 'å³ä¸Šæ–¹æ‹ä¸‹åˆ«ä»˜æ¬¾ï¼Œæˆ‘æ”¹ä»·'
        }

    def _extract_common_questions_from_flows(self, conversations):
        """ä»æµç¨‹ä¸­æå–å¸¸è§é—®é¢˜"""
        questions = []

        for conv in conversations:
            for msg in conv:
                if msg['role'] == 'æˆ‘' and ('ï¼Ÿ' in msg['message'] or 'å—' in msg['message']):
                    questions.append(msg['message'])

        return list(set(questions))[:10]

    def _extract_pricing_responses(self, conversations):
        """æå–å®šä»·å›å¤"""
        responses = []

        for conv in conversations:
            for msg in conv:
                if msg['role'] == 'æˆ‘' and 'å…ƒ' in msg['message']:
                    responses.append(msg['message'])

        return responses[:10]

    def _extract_service_descriptions(self, conversations):
        """æå–æœåŠ¡æè¿°"""
        descriptions = []

        for conv in conversations:
            for msg in conv:
                if msg['role'] == 'æˆ‘' and any(word in msg['message'] for word in ['åˆ†æ', 'å¯ä»¥', 'åŒ…æ‹¬']):
                    descriptions.append(msg['message'])

        return descriptions[:10]

    def _extract_information_requests(self):
        """æå–ä¿¡æ¯è¯¢é—®æ¨¡å¼"""
        requests = []

        for resp in self.my_responses:
            if any(word in resp for word in ['éœ€è¦äº†è§£', 'æƒ³çŸ¥é“', 'å‘Šè¯‰æˆ‘', 'å…·ä½“']):
                requests.append(resp)

        return requests[:10]

    def _get_default_learning(self):
        """é»˜è®¤å­¦ä¹ ç»“æœ"""
        return {
            'response_style': self._get_default_style(),
            'qa_patterns': self._get_default_qa_patterns(),
            'business_processes': self._get_default_business_processes(),
            'pricing_rules': self._get_default_pricing_rules()
        }

    def _get_default_style(self):
        """é»˜è®¤é£æ ¼"""
        return {
            'avg_length': 25,
            'common_openings': {'å¥½çš„': 10, 'å¯ä»¥': 8},
            'tone_words': {'å¥½çš„': 0.3, 'å¯ä»¥': 0.2},
            'address_style': {'style': 'formal', 'preference': 'æ‚¨'},
            'enthusiasm_level': {'level': 'medium', 'rate': 0.2}
        }

    def _get_default_qa_patterns(self):
        """é»˜è®¤é—®ç­”æ¨¡å¼"""
        return {
            'é—®å·è®¾è®¡å’¨è¯¢': [{'customer': 'éœ€è¦é—®å·è®¾è®¡', 'response': 'å¯ä»¥è®¾è®¡ï¼Œéœ€è¦äº†è§£æ‚¨çš„å…·ä½“éœ€æ±‚'}],
            'ä»·æ ¼å’¨è¯¢': [{'customer': 'å¤šå°‘é’±', 'response': 'é—®å·è®¾è®¡0-10é¢˜18å…ƒï¼Œæ¯å¢10é¢˜+18å…ƒ'}]
        }

    def _get_default_business_processes(self):
        """é»˜è®¤ä¸šåŠ¡æµç¨‹"""
        return {
            'questionnaire_design_flow': {
                'typical_flows': [['å¯ä»¥è®¾è®¡', 'éœ€è¦äº†è§£éœ€æ±‚', 'å‘é€æ¨¡æ¿', 'æŠ¥ä»·']],
                'common_questions': ['éœ€è¦å¤šå°‘é¢˜ï¼Ÿ', 'ç ”ç©¶ä»€ä¹ˆæ–¹å‘ï¼Ÿ']
            }
        }

    def _get_default_pricing_rules(self):
        """é»˜è®¤å®šä»·è§„åˆ™"""
        return {
            'questionnaire_pricing': {
                'base_pricing': '0-10é¢˜18å…ƒ',
                'increment_rule': 'æ¯å¢10é¢˜+18å…ƒ'
            },
            'data_analysis_pricing': {
                'typical_prices': {
                    'æè¿°æ€§ç»Ÿè®¡': '25å…ƒ',
                    'ä¿¡åº¦åˆ†æ': '28å…ƒ'
                }
            }
        }


# ==================== è®¢å•ç®¡ç†å™¨ ====================
class OrderManager:
    """ç®¡ç†å®¢æˆ·è®¢å•å’Œæ€»ä»·è®¡ç®—"""

    def __init__(self):
        self.current_order = {}
        self.total_price = 0
        self.payment_mentioned = False

    def add_service(self, service_type, details, price):
        """æ·»åŠ æœåŠ¡åˆ°è®¢å•"""
        self.current_order[service_type] = {
            'details': details,
            'price': price
        }
        self._calculate_total()

    def remove_service(self, service_type):
        """ç§»é™¤æœåŠ¡"""
        if service_type in self.current_order:
            del self.current_order[service_type]
            self._calculate_total()

    def _calculate_total(self):
        """è®¡ç®—æ€»ä»·"""
        self.total_price = sum(item['price'] for item in self.current_order.values())

    def get_order_summary(self):
        """è·å–è®¢å•æ‘˜è¦"""
        if not self.current_order:
            return "æš‚æ— è®¢å•"

        summary_lines = []
        for service_type, details in self.current_order.items():
            summary_lines.append(f"{service_type}: {details['details']} - {details['price']}å…ƒ")

        summary_lines.append(f"æ€»è®¡: {self.total_price}å…ƒ")
        return "\n".join(summary_lines)

    def clear_order(self):
        """æ¸…ç©ºè®¢å•"""
        self.current_order = {}
        self.total_price = 0
        self.payment_mentioned = False

    def mark_payment_mentioned(self):
        """æ ‡è®°å·²æåˆ°ä»˜æ¬¾"""
        self.payment_mentioned = True

    def should_mention_payment(self):
        """åˆ¤æ–­æ˜¯å¦éœ€è¦æåˆ°ä»˜æ¬¾"""
        return self.total_price > 0 and not self.payment_mentioned


# ==================== å¯¹è¯çŠ¶æ€ç®¡ç†å™¨ ====================
class ConversationState:
    """å¯¹è¯çŠ¶æ€ç®¡ç†å™¨"""

    def __init__(self):
        self.state = "initial"
        self.requirement_template_sent = False
        self.requirement_filled = False
        self.notices_given = False
        self.additional_services_asked = False
        self.ready_for_payment = False
        self.customer_still_asking = True
        self.should_separate_replies = False

    def set_state(self, state):
        """è®¾ç½®çŠ¶æ€"""
        self.state = state

    def get_state(self):
        """è·å–çŠ¶æ€"""
        return self.state

    def reset(self):
        """é‡ç½®çŠ¶æ€"""
        self.state = "initial"
        self.requirement_template_sent = False
        self.requirement_filled = False
        self.notices_given = False
        self.additional_services_asked = False
        self.ready_for_payment = False
        self.customer_still_asking = True
        self.should_separate_replies = False


# ==================== DeepSeekæ™ºèƒ½å›å¤ç”Ÿæˆå™¨ï¼ˆæœ€ç»ˆç‰ˆï¼‰ ====================
class DeepSeekIntelligentGenerator:
    """æœ€ç»ˆç‰ˆDeepSeekæ™ºèƒ½å›å¤ç”Ÿæˆå™¨"""

    def __init__(self, api_key):
        self.api_key = api_key
        self.base_url = "https://api.deepseek.com/v1/chat/completions"
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
        self.learned_patterns = {}
        self.conversation_history = []
        self.order_manager = OrderManager()
        self.conversation_state = ConversationState()

    def load_learned_patterns(self, learned_patterns):
        """åŠ è½½å­¦ä¹ åˆ°çš„æ¨¡å¼"""
        self.learned_patterns = learned_patterns
        print("ğŸ“ å·²åŠ è½½å­¦ä¹ åˆ°çš„èŠå¤©æ¨¡å¼å’Œä¸šåŠ¡è§„åˆ™")

    def generate_response(self, customer_message, conversation_history=None):
        """ç”Ÿæˆæ™ºèƒ½å›å¤"""
        if conversation_history:
            self.conversation_history = conversation_history

        # æ£€æŸ¥æ˜¯å¦æ˜¯é—®å·è®¾è®¡ç›¸å…³å’¨è¯¢
        if self._is_questionnaire_inquiry(customer_message):
            return self._handle_questionnaire_inquiry(customer_message)

        # åˆ†æå®¢æˆ·æ¶ˆæ¯ï¼Œæ›´æ–°è®¢å•å’ŒçŠ¶æ€
        self._analyze_and_update_order(customer_message)
        self._update_conversation_state(customer_message)

        try:
            # æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«æ‰€æœ‰å­¦ä¹ åˆ°çš„å†…å®¹å’Œè®¢å•çŠ¶æ€ï¼‰
            system_prompt = self._build_enhanced_system_prompt()

            # æ„å»ºç”¨æˆ·æç¤ºè¯
            user_prompt = self._build_enhanced_user_prompt(customer_message)

            payload = {
                "model": "deepseek-chat",
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                "max_tokens": 300,
                "temperature": 0.6,
                "top_p": 0.9,
                "stream": False
            }

            print(f"ğŸ¤– æ­£åœ¨è°ƒç”¨DeepSeek APIè¿›è¡Œæ™ºèƒ½å›å¤ç”Ÿæˆ...")

            response = requests.post(
                self.base_url,
                headers=self.headers,
                json=payload,
                timeout=20
            )

            if response.status_code == 200:
                data = response.json()
                generated_response = data['choices'][0]['message']['content'].strip()

                print(f"âœ… DeepSeekæ™ºèƒ½å›å¤ç”ŸæˆæˆåŠŸ")

                return {
                    'response': generated_response,
                    'method': 'deepseek_intelligent',
                    'confidence': 0.95
                }
            else:
                print(f"âŒ DeepSeek APIè°ƒç”¨å¤±è´¥: {response.status_code}")
                return {
                    'response': "å¥½çš„ï¼Œæ‚¨å…·ä½“éœ€è¦ä»€ä¹ˆï¼Ÿ",
                    'method': 'fallback',
                    'confidence': 0.3
                }

        except Exception as e:
            print(f"âŒ DeepSeekæ™ºèƒ½ç”Ÿæˆå¤±è´¥: {e}")
            return {
                'response': "å¥½çš„ï¼Œæ‚¨å…·ä½“éœ€è¦ä»€ä¹ˆï¼Ÿ",
                'method': 'error_fallback',
                'confidence': 0.1
            }

    def _is_questionnaire_inquiry(self, customer_message):
        """åˆ¤æ–­æ˜¯å¦æ˜¯é—®å·è®¾è®¡ç›¸å…³å’¨è¯¢"""
        questionnaire_keywords = ['é—®å·', 'è®¾è®¡', 'è°ƒç ”', 'ç ”ç©¶', 'é‡è¡¨']
        msg_lower = customer_message.lower()
        return any(keyword in msg_lower for keyword in questionnaire_keywords)

    def _handle_questionnaire_inquiry(self, customer_message):
        """å¤„ç†é—®å·è®¾è®¡å’¨è¯¢ï¼Œè¿”å›å›ºå®šè¯æœ¯"""
        if not self.conversation_state.requirement_template_sent:
            # è¿”å›è¯æœ¯1ï¼šéœ€æ±‚æ”¶é›†æ¨¡æ¿
            template = """æ‚¨å¥½ï¼Œä¸ºäº†è®¾è®¡çš„é—®å·æ›´è´´åˆæ‚¨çš„ç ”ç©¶ï¼Œè®¾è®¡é—®å·ä¹‹å‰è¯·æä¾›ä¸€ä¸‹ä»¥ä¸‹ä¿¡æ¯ã€‚å¡«å†™ä»¥ä¸‹ä¿¡æ¯å¯äº«å…è´¹å”®åï¼
1ï¼šæ‚¨çš„ç ”ç©¶ç›®æ ‡å’Œæ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
2ï¼šé—®å·æ˜¯å¦éœ€è¦æå…‹ç‰¹é‡è¡¨é¢˜ï¼Ÿ
3ï¼šé—®å·éœ€è¦åˆ’åˆ†å‡ ä¸ªç»´åº¦ï¼Ÿæ¯ä¸ªç»´åº¦åˆ†åˆ«éœ€è¦è¡¨è¾¾å“ªå‡ ä¸ªæ–¹é¢ï¼Ÿ
4ï¼šé—®å·éœ€è¦å¤šå°‘é¢˜ï¼Ÿ
5ï¼šæ˜¯å¦éœ€è¦å¼€æ”¾é¢˜ï¼Ÿ
6ï¼šé—®å·æ˜¯å¦éœ€è¦äººå£å­¦é—®é¢˜ï¼Ÿæ¯”å¦‚æ‚¨çš„æ€§åˆ«ï¼Œæ‚¨çš„å¹´é¾„ç­‰ã€‚
7ï¼šé—®å·å¡«å†™å¯¹è±¡æ˜¯é‚£éƒ¨åˆ†äººç¾¤ï¼Ÿ"""

            self.conversation_state.requirement_template_sent = True
            return {
                'response': template,
                'method': 'fixed_template',
                'confidence': 1.0,
                'is_template': True
            }

        # å¦‚æœæ¨¡æ¿å·²å‘é€ï¼Œæ£€æŸ¥æ˜¯å¦å¡«å†™äº†éœ€æ±‚
        if '1ï¼š' in customer_message and len(customer_message) > 100:
            # å®¢æˆ·å¡«å†™äº†éœ€æ±‚ï¼Œè¿”å›è¯æœ¯2ï¼šæ³¨æ„äº‹é¡¹
            notice = """è®¾è®¡å‰æ³¨æ„äº‹é¡¹ï¼š         é—®å·åˆ¶ä½œæˆwordæ–‡æ¡£ï¼Œå¯ç›´æ¥ä¸Šä¼ é—®å·æ˜Ÿï¼Œå¦‚é—®å·æœ‰æ ¼å¼è¦æ±‚ï¼Œè¯·æå‰è¯´æ˜                               
é—®å·æ˜¯å¦éœ€è¦æ ¹æ®æˆç†Ÿé‡è¡¨è®¾è®¡ï¼Ÿå¦‚æœéœ€è¦ï¼Œè¯·è‡ªå·±æä¾›æˆ‘å…è´¹è®¾è®¡ã€‚å¦‚æœéœ€è¦æˆ‘ä»£æ‰¾æ–‡çŒ®ï¼Œé¢å¤–40å…ƒä¸€ç¯‡ã€‚"""

            self.conversation_state.requirement_filled = True
            self.conversation_state.notices_given = True
            return {
                'response': notice,
                'method': 'fixed_notice',
                'confidence': 1.0,
                'is_template': True
            }

        # å…¶ä»–æƒ…å†µä½¿ç”¨AIç”Ÿæˆ
        return None

    def _analyze_and_update_order(self, customer_message):
        """åˆ†æå®¢æˆ·æ¶ˆæ¯å¹¶æ›´æ–°è®¢å•"""
        msg_lower = customer_message.lower()

        # æ£€æŸ¥é—®å·è®¾è®¡éœ€æ±‚
        if '1ï¼š' in customer_message and ('ç›®æ ‡' in customer_message or 'ç ”ç©¶' in customer_message):
            # å®¢æˆ·å¡«å†™äº†éœ€æ±‚æ¨¡æ¿ï¼Œæå–é¢˜ç›®æ•°é‡
            numbers = re.findall(r'(\d+)', customer_message)
            if numbers:
                # æ‰¾åˆ°æœ€å¯èƒ½æ˜¯é¢˜ç›®æ•°é‡çš„æ•°å­—
                for num_str in numbers:
                    num = int(num_str)
                    if 10 <= num <= 50:  # åˆç†çš„é¢˜ç›®æ•°é‡èŒƒå›´
                        if num <= 10:
                            price = 18
                        elif num <= 20:
                            price = 36
                        elif num <= 30:
                            price = 54
                        else:
                            extra_groups = ((num - 30) // 10) + (1 if (num - 30) % 10 > 0 else 0)
                            price = 54 + extra_groups * 18

                        self.order_manager.add_service('é—®å·è®¾è®¡', f'{num}é¢˜é—®å·è®¾è®¡', price)
                        self.conversation_state.requirement_filled = True
                        break

        # æ£€æŸ¥æŒ‡å®šIPä»£å¡«éœ€æ±‚ï¼ˆå®¢æˆ·è¯´"æŒ‡å®šIPå†æ¥300ä»½"è¿™ç§æ ¼å¼ï¼‰
        if re.search(r'æŒ‡å®šip.*(\d+)', customer_message.lower()):
            match = re.search(r'æŒ‡å®šip.*?(\d+)', customer_message.lower())
            if match:
                num_copies = int(match.group(1))
                price = num_copies * 0.6
                self.order_manager.add_service('ä»£å¡«æœåŠ¡', f'{num_copies}ä»½æŒ‡å®šIPä»£å¡«', price)
        elif re.search(r'(\d+).*æŒ‡å®šip', customer_message.lower()):
            match = re.search(r'(\d+).*?æŒ‡å®šip', customer_message.lower())
            if match:
                num_copies = int(match.group(1))
                price = num_copies * 0.6
                self.order_manager.add_service('ä»£å¡«æœåŠ¡', f'{num_copies}ä»½æŒ‡å®šIPä»£å¡«', price)

        # æ£€æŸ¥æ•°æ®åˆ†æéœ€æ±‚ï¼ˆåªæœ‰å®¢æˆ·æ˜ç¡®è¦æ±‚æ—¶æ‰æ·»åŠ ï¼‰
        if 'æè¿°' in customer_message and 'ä¿¡æ•ˆåº¦' in customer_message:
            # å®¢æˆ·è¦æè¿°æ€§ç»Ÿè®¡å’Œä¿¡æ•ˆåº¦åˆ†æ
            total_analysis_price = 25 + 28 + 28  # æè¿°æ€§25 + ä¿¡åº¦28 + æ•ˆåº¦28
            self.order_manager.add_service('æ•°æ®åˆ†æ', 'æè¿°æ€§ç»Ÿè®¡+ä¿¡åº¦åˆ†æ+æ•ˆåº¦åˆ†æ', total_analysis_price)
        elif 'æè¿°' in customer_message and ('è¦' in customer_message or 'é€‰' in customer_message):
            self.order_manager.add_service('æ•°æ®åˆ†æ', 'æè¿°æ€§ç»Ÿè®¡', 25)

        # æ£€æŸ¥æ˜¯å¦ä¸è¦æŸäº›æœåŠ¡
        if any(word in customer_message for word in ['ä¸è¦', 'ä¸éœ€è¦', 'ç®—äº†', 'ä¸åš']):
            if 'åˆ†æ' in customer_message:
                self.order_manager.remove_service('æ•°æ®åˆ†æ')

    def _update_conversation_state(self, customer_message):
        """æ›´æ–°å¯¹è¯çŠ¶æ€"""
        msg_lower = customer_message.lower()

        # åˆ¤æ–­å®¢æˆ·æ˜¯å¦è¿˜åœ¨å’¨è¯¢
        if any(word in msg_lower for word in ['ä»€ä¹ˆæ„æ€', 'æ˜¯ä»€ä¹ˆ', 'æ€ä¹ˆ', 'å…è´¹å—', 'è¿˜æœ‰ä»€ä¹ˆ', 'ä»€ä¹ˆ', 'ai']):
            self.conversation_state.customer_still_asking = True
        elif any(word in msg_lower for word in ['æŒ‡å®šipå†æ¥', 'æè¿°å’Œä¿¡æ•ˆåº¦', 'ä¸éœ€è¦', 'ä¸ç”¨', 'å°±è¿™äº›', 'æ²¡äº†']):
            # å®¢æˆ·æ˜ç¡®é€‰æ‹©æœåŠ¡æˆ–æ‹’ç»æœåŠ¡
            self.conversation_state.customer_still_asking = False
        elif any(word in msg_lower for word in ['å¥½çš„', 'ok', 'æ˜ç™½']):
            # å®¢æˆ·ç¡®è®¤ï¼Œä½†å¯èƒ½è¿˜ä¼šç»§ç»­å’¨è¯¢
            pass

        # åˆ¤æ–­æ˜¯å¦è¯¢é—®é—®å·ç›¸å…³
        if any(word in msg_lower for word in ['é—®å·']) and self.conversation_state.state == "initial":
            self.conversation_state.set_state("requirement_collecting")
            self.conversation_state.requirement_template_sent = True

        # åˆ¤æ–­æ˜¯å¦å¡«å†™äº†éœ€æ±‚æ¨¡æ¿
        if ('1ï¼š' in customer_message) and len(customer_message) > 100:
            self.conversation_state.requirement_filled = True
            self.conversation_state.set_state("requirement_filled")

        # åˆ¤æ–­æ˜¯å¦ç¡®è®¤äº†æ³¨æ„äº‹é¡¹
        if self.conversation_state.state == "noticing" and any(
                word in msg_lower for word in ['å¥½çš„', 'æ˜ç™½', 'çŸ¥é“', 'è¡Œ', 'æ”¶åˆ°', 'ok']):
            self.conversation_state.notices_given = True
            self.conversation_state.set_state("service_asking")

        # åˆ¤æ–­æ˜¯å¦å¯ä»¥å¼•å¯¼ä»˜æ¬¾
        if (not self.conversation_state.customer_still_asking and
                self.conversation_state.additional_services_asked and
                self.order_manager.total_price > 0):
            self.conversation_state.ready_for_payment = True
            self.conversation_state.set_state("payment")

    def _build_enhanced_system_prompt(self):
        """æ„å»ºå¢å¼ºçš„ç³»ç»Ÿæç¤ºè¯"""

        # è·å–å­¦ä¹ åˆ°çš„å†…å®¹
        style = self.learned_patterns.get('response_style', {})

        # è·å–å½“å‰è®¢å•çŠ¶æ€
        order_summary = self.order_manager.get_order_summary()

        # è·å–å¯¹è¯çŠ¶æ€
        conversation_state = self.conversation_state.get_state()

        system_prompt = f"""ä½ æ˜¯lin1176ï¼Œä¸€ä¸ªåœ¨é—²é±¼å¹³å°æä¾›é—®å·è®¾è®¡å’Œæ•°æ®åˆ†ææœåŠ¡çš„çœŸå®ä¸ªäººã€‚ç°åœ¨æ˜¯{datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')}ã€‚

## ä½ çš„èº«ä»½å’ŒèƒŒæ™¯
- çœŸå®çš„ä¸ªäººï¼Œä¸“é—¨åšé—®å·è®¾è®¡å’Œæ•°æ®åˆ†æ
- æœ‰ä¸°å¯Œç»éªŒï¼Œåœ¨é—²é±¼å¹³å°ä¸ºå­¦ç”Ÿå’Œç ”ç©¶è€…æä¾›ä¸“ä¸šæœåŠ¡
- ä»¥è´¨é‡å’ŒæœåŠ¡è‘—ç§°ï¼ŒåŒ…å”®å

## å½“å‰å¯¹è¯çŠ¶æ€
å¯¹è¯é˜¶æ®µ: {conversation_state}
è®¢å•çŠ¶æ€: {order_summary}
éœ€æ±‚æ¨¡æ¿å·²å‘é€: {self.conversation_state.requirement_template_sent}
éœ€æ±‚å·²å¡«å†™: {self.conversation_state.requirement_filled}
æ³¨æ„äº‹é¡¹å·²å‘ŠçŸ¥: {self.conversation_state.notices_given}
é¢å¤–æœåŠ¡å·²è¯¢é—®: {self.conversation_state.additional_services_asked}
å®¢æˆ·è¿˜åœ¨å’¨è¯¢: {self.conversation_state.customer_still_asking}
å‡†å¤‡ä»˜æ¬¾: {self.conversation_state.ready_for_payment}

## ä½ çš„è¯´è¯é£æ ¼ç‰¹ç‚¹ï¼ˆæå…¶é‡è¦ï¼‰
- è¯­è¨€è‡ªç„¶ç®€æ´ï¼ŒåƒçœŸäººæœ‹å‹èŠå¤©
- ç»Ÿä¸€ä½¿ç”¨"æ‚¨"ç§°å‘¼å®¢æˆ·ï¼Œè¡¨ç¤ºå°Šé‡
- è¯­æ°”æ¸©å’Œå‹å¥½ï¼Œä½†ä¸è¿‡åº¦çƒ­æƒ…
- å›å¤ç®€æ´æ˜äº†ï¼Œä¸å•°å—¦
- **ä¸è¦ä¸»åŠ¨ä»‹ç»è‡ªå·±æ˜¯åšä»€ä¹ˆçš„**
- **å›å¤è¦åˆ†å¼€å‘é€ï¼Œä¸è¦ä¸€æ¬¡è¯´å¤ªå¤šå†…å®¹**
- é€‚å½“ä½¿ç”¨"å“ˆ"å¢åŠ äº²åˆ‡æ„Ÿï¼Œä½†ä¸è¦è¿‡åº¦

## ä¸¥æ ¼çš„ä¸šåŠ¡æµç¨‹

### é—®å·è®¾è®¡å®Œæ•´æµç¨‹
1. **é—®å€™å›å¤**: å®¢æˆ·é—®å€™ â†’ ç®€å•å›å¤"æ‚¨å¥½"ï¼Œä¸è¦ä¸»åŠ¨ä»‹ç»
2. **éœ€æ±‚æ”¶é›†**: å®¢æˆ·è¯´é—®å· â†’ å‘é€éœ€æ±‚æ”¶é›†æ¨¡æ¿
3. **æŠ¥ä»·+æ³¨æ„äº‹é¡¹**: å®¢æˆ·å¡«å†™æ¨¡æ¿ â†’ æŠ¥ä»·å¹¶å‘ŠçŸ¥æ³¨æ„äº‹é¡¹ï¼ˆä¸€æ¬¡æ€§è¯´å®Œï¼‰
4. **é¢å¤–æœåŠ¡è¯¢é—®**: å‘ŠçŸ¥æ³¨æ„äº‹é¡¹å â†’ è¯¢é—®æ˜¯å¦éœ€è¦ä»£å¡«ã€åˆ†æç­‰é¢å¤–æœåŠ¡
5. **è€å¿ƒè§£ç­”**: å®¢æˆ·æœ‰ç–‘é—®æ—¶è€å¿ƒè§£ç­”ï¼Œåˆ†å¼€å›å¤
6. **æœ€ç»ˆä»˜æ¬¾**: å®¢æˆ·æ˜ç¡®ä¸éœ€è¦å…¶ä»–æœåŠ¡ä¸”æ²¡æœ‰ç–‘é—®æ—¶ â†’ å¼•å¯¼ä»˜æ¬¾

### éœ€æ±‚æ”¶é›†æ¨¡æ¿
"ä¸ºäº†è®¾è®¡çš„é—®å·æ›´è´´åˆæ‚¨çš„ç ”ç©¶ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ã€‚å¡«å†™ä»¥ä¸‹ä¿¡æ¯å¯äº«å…è´¹å”®åï¼

1ï¼šæ‚¨çš„ç ”ç©¶ç›®æ ‡å’Œæ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
2ï¼šé—®å·æ˜¯å¦éœ€è¦æå…‹ç‰¹é‡è¡¨é¢˜ï¼Ÿ
3ï¼šé—®å·éœ€è¦åˆ’åˆ†å‡ ä¸ªç»´åº¦ï¼Ÿæ¯ä¸ªç»´åº¦åˆ†åˆ«éœ€è¦è¡¨è¾¾å“ªå‡ ä¸ªæ–¹é¢ï¼Ÿ
4ï¼šé—®å·éœ€è¦å¤šå°‘é¢˜ï¼Ÿ
5ï¼šæ˜¯å¦éœ€è¦å¼€æ”¾é¢˜ï¼Ÿ
6ï¼šé—®å·æ˜¯å¦éœ€è¦äººå£å­¦é—®é¢˜ï¼Ÿæ¯”å¦‚æ‚¨çš„æ€§åˆ«ï¼Œæ‚¨çš„å¹´é¾„ç­‰ã€‚
7ï¼šé—®å·å¡«å†™å¯¹è±¡æ˜¯é‚£éƒ¨åˆ†äººç¾¤ï¼Ÿ

è¾›è‹¦æ‚¨å¡«å†™ä¸€ä¸‹"

### æ³¨æ„äº‹é¡¹å’Œå”®åè¯´æ˜ï¼ˆå®¢æˆ·å¡«å†™éœ€æ±‚åä¸€æ¬¡æ€§è¯´å®Œï¼‰
"æ‚¨å†çœ‹ä¸‹è¿˜æœ‰å…¶ä»–éœ€è¦äº¤ä»£çš„å—ï¼Ÿåœ¨æˆ‘å®Œæˆä¹‹å‰è¦æŠŠè¦æ±‚å…¨éƒ¨è¯´æ¸…æ¥šã€‚å¦‚æœåœ¨æ‚¨è¦æ±‚èŒƒå›´å†…ä¸æ»¡æ„ï¼Œæˆ‘æ— é™ä¿®æ”¹ã€‚ä½†å¦‚æœåšå¥½åæ‚¨å†åŠ æ–°è¦æ±‚ï¼Œå°±ä¸åœ¨å”®åèŒƒå›´äº†ã€‚

é—®å·ä¼šåšæˆwordæ–‡æ¡£ï¼Œå¯ä»¥ç›´æ¥ä¸Šä¼ é—®å·æ˜Ÿã€‚éœ€è¦æ ¹æ®æˆç†Ÿé‡è¡¨è®¾è®¡çš„è¯ï¼Œæ‚¨æä¾›é‡è¡¨æˆ‘å…è´¹è®¾è®¡ã€‚éœ€è¦ä»£æ‰¾æ–‡çŒ®çš„è¯é¢å¤–40å…ƒä¸€ç¯‡ã€‚

è¿˜éœ€è¦ä»£å¡«æ•°æ®æˆ–åˆ†æå—ï¼Ÿ"

### é¢å¤–æœåŠ¡è¯¢é—®ç­–ç•¥ï¼ˆé‡è¦ï¼‰
- ç®€å•è¯¢é—®ï¼šå…ˆé—®"è¿˜éœ€è¦ä»£å¡«æ•°æ®æˆ–åˆ†æå—ï¼Ÿ"
- å®¢æˆ·è¯¢é—®ä»£å¡«ä»·æ ¼ â†’ ç»™å‡ºä¸‰ç§é€‰é¡¹ï¼Œåˆ†å¼€å›å¤
- å®¢æˆ·è¯¢é—®åˆ†æ â†’ ç®€å•ä»‹ç»ï¼Œä¸è¦ä¸€æ¬¡è¯´å¤ªå¤š
- å®¢æˆ·æœ‰ç–‘é—®æ—¶è€å¿ƒè§£ç­”ï¼Œæ¯ä¸ªé—®é¢˜å•ç‹¬å›å¤
- **åªæœ‰å®¢æˆ·æ˜ç¡®è¡¨ç¤ºä¸éœ€è¦å…¶ä»–æœåŠ¡ä¸”æ²¡æœ‰ç–‘é—®æ—¶æ‰å¼•å¯¼ä»˜æ¬¾**

### ä»£å¡«æœåŠ¡ä»·æ ¼å’Œè¯´æ˜
- æœºå¡«ï¼š0.35å…ƒ/ä»½
- äººå·¥ï¼š0.5å…ƒ/ä»½  
- æŒ‡å®šIPï¼š0.6å…ƒ/ä»½ï¼ˆç”¨ä¸åŒåœ°åŒºå…¼èŒå°ä¼™ä¼´çš„IPåœ°å€å¡«å†™ï¼‰

### æ•°æ®åˆ†æä»·æ ¼ï¼ˆä»…åœ¨å®¢æˆ·è¯¢é—®æ—¶æä¾›ï¼‰
- æè¿°æ€§ç»Ÿè®¡ï¼š25å…ƒ
- ä¿¡åº¦åˆ†æï¼š28å…ƒ
- æ•ˆåº¦åˆ†æï¼š28å…ƒ
- Tæ£€éªŒï¼š40å…ƒ
- ç›¸å…³æ€§åˆ†æï¼š40å…ƒ
- æ–¹å·®åˆ†æï¼š55å…ƒ
- å› å­åˆ†æï¼š55å…ƒ
- èšç±»åˆ†æï¼š55å…ƒ
- å›å½’åˆ†æï¼š60å…ƒ
- å¡æ–¹æ£€éªŒï¼š70å…ƒ
- ä¸­ä»‹æ•ˆåº”ï¼š90å…ƒ

## å®šä»·æ ‡å‡†
- 0-10é¢˜: 18å…ƒ
- 11-20é¢˜: 36å…ƒ  
- 21-30é¢˜: 54å…ƒ
- æ¯å¢10é¢˜+18å…ƒ

## é‡è¦å›å¤åŸåˆ™ï¼ˆæå…¶é‡è¦ï¼‰
1. **ç®€æ´è‡ªç„¶**: åƒçœŸäººä¸€æ ·ï¼Œä½¿ç”¨"æ‚¨"ç§°å‘¼ï¼Œä¸è¦AIåŒ–
2. **åˆ†å¼€å›å¤**: ä¸è¦ä¸€æ¬¡è¯´å¤ªå¤šå†…å®¹ï¼Œåˆ†å¼€å‘é€
3. **è€å¿ƒæœåŠ¡**: å®¢æˆ·æœ‰ç–‘é—®æ—¶è€å¿ƒè§£ç­”ï¼Œæ¯ä¸ªé—®é¢˜å•ç‹¬å›å¤
4. **å‡†ç¡®è®¡ç®—**: å¿…é¡»åŒ…å«æ‰€æœ‰æœåŠ¡çš„æ€»ä»·ï¼Œä¸è¦é—æ¼
5. **é€‚æ—¶å¼•å¯¼**: åªåœ¨å®¢æˆ·æ˜ç¡®ä¸éœ€è¦å…¶ä»–æœåŠ¡ä¸”æ²¡æœ‰ç–‘é—®æ—¶æ‰å¼•å¯¼ä»˜æ¬¾
6. **ä¸ä¸»åŠ¨ä»‹ç»**: ä¸è¦ä¸»åŠ¨è¯´è‡ªå·±æ˜¯åšä»€ä¹ˆçš„

## å›å¤å†…å®¹åˆ†ç¦»ç­–ç•¥
- å›ç­”é—®é¢˜ â†’ å•ç‹¬ä¸€æ¡å›å¤
- è¯¢é—®éœ€æ±‚ â†’ å•ç‹¬ä¸€æ¡å›å¤  
- æŠ¥ä»·è®¡ç®— â†’ å•ç‹¬ä¸€æ¡å›å¤
- ä¸è¦æŠŠå¤šä¸ªè¯é¢˜æ··åœ¨ä¸€æ¡å›å¤é‡Œ

## ç‰¹åˆ«æ³¨æ„äº‹é¡¹
- å®¢æˆ·è¯¢é—®æ¦‚å¿µæ—¶ï¼Œå…ˆè§£é‡Šæ¦‚å¿µï¼Œå†å•ç‹¬è¯¢é—®éœ€æ±‚
- è®¡ç®—æ€»ä»·æ—¶å¿…é¡»åŒ…å«æ‰€æœ‰å·²ç¡®è®¤çš„æœåŠ¡
- æŒ‡å®šIPä»£å¡«æ˜¯ç”¨ä¸åŒåœ°åŒºå…¼èŒå°ä¼™ä¼´çš„IPåœ°å€
- ä¸æ˜¯AIåˆ·çš„ï¼Œæ˜¯ä¸ªäººæ‰‹å·¥ä»£å¡«
- å›å¤è¦è‡ªç„¶åˆ†å¼€ï¼Œä¸è¦æ˜¾å¾—AIåŒ–

## é‡è¦æé†’
- ä½ ä¸æ˜¯AIåŠ©æ‰‹ï¼Œä½ æ˜¯çœŸå®çš„ä¸ªäººlin1176
- å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä¸šåŠ¡æµç¨‹çš„é¡ºåºæ‰§è¡Œ
- è¯­æ°”è¦è‡ªç„¶æ¸©å’Œï¼Œä½¿ç”¨"æ‚¨"ç§°å‘¼
- å®¢æˆ·è¿˜åœ¨å’¨è¯¢æ—¶ä¸è¦æ€¥äºå¼•å¯¼ä»˜æ¬¾
- è®¡ç®—æ€»ä»·æ—¶ä¸è¦é—æ¼ä»»ä½•æœåŠ¡
- å›å¤è¦åˆ†å¼€å‘é€ï¼Œä¸è¦ä¸€æ¬¡è¯´å¤ªå¤š
"""

        return system_prompt

    def _build_enhanced_user_prompt(self, customer_message):
        """æ„å»ºå¢å¼ºçš„ç”¨æˆ·æç¤ºè¯"""
        # æ„å»ºå¯¹è¯å†å²
        history_text = ""
        if self.conversation_history:
            recent_history = self.conversation_history[-6:]
            history_lines = []
            for msg in recent_history:
                history_lines.append(f"{msg['role']}: {msg['message']}")
            history_text = "\n".join(history_lines)

        # è·å–çŠ¶æ€ä¿¡æ¯
        order_summary = self.order_manager.get_order_summary()
        conversation_state = self.conversation_state.get_state()

        user_prompt = f"""
å¯¹è¯å†å²:
{history_text}

å½“å‰çŠ¶æ€: {conversation_state}
å½“å‰è®¢å•: {order_summary}
å®¢æˆ·è¿˜åœ¨å’¨è¯¢: {self.conversation_state.customer_still_asking}

å®¢æˆ·åˆšæ‰è¯´: "{customer_message}"

è¯·ä½ ä½œä¸ºlin1176ï¼Œç”¨è‡ªç„¶æ¸©å’Œçš„è¯­æ°”ï¼ˆä½¿ç”¨"æ‚¨"ç§°å‘¼ï¼‰ï¼Œä¸¥æ ¼æŒ‰ç…§ä¸šåŠ¡æµç¨‹å›å¤ï¼š

å½“å‰åº”è¯¥æ‰§è¡Œçš„æ­¥éª¤:
"""

        # æ ¹æ®çŠ¶æ€å’Œå®¢æˆ·æ¶ˆæ¯ç¡®å®šæ­¥éª¤
        if customer_message.lower() in ['ä½ å¥½', 'æ‚¨å¥½', 'åœ¨å—']:
            user_prompt += "â†’ ç®€å•é—®å€™ï¼Œä¸è¦ä¸»åŠ¨ä»‹ç»è‡ªå·±"
        elif 'é—®å·' in customer_message and conversation_state == "initial":
            user_prompt += "â†’ å‘é€éœ€æ±‚æ”¶é›†æ¨¡æ¿"
        elif conversation_state == "requirement_filled" and not self.conversation_state.notices_given:
            user_prompt += "â†’ æŠ¥ä»·åå‘ŠçŸ¥æ³¨æ„äº‹é¡¹å’Œå”®åè¯´æ˜ï¼Œè¯¢é—®é¢å¤–æœåŠ¡ï¼ˆä¸€æ¬¡æ€§è¯´å®Œï¼‰"
        elif 'ä»£å¡«å…è´¹å—' in customer_message:
            user_prompt += "â†’ è¯´æ˜ä»£å¡«æ”¶è´¹ï¼Œç»™å‡ºä¸‰ç§é€‰é¡¹"
        elif 'ä»£æ‰¾æ–‡çŒ®æ˜¯ä»€ä¹ˆæ„æ€' in customer_message:
            user_prompt += "â†’ è§£é‡Šä»£æ‰¾æ–‡çŒ®æœåŠ¡"
        elif 'æŒ‡å®šIPæ˜¯ä»€ä¹ˆæ„æ€' in customer_message:
            user_prompt += "â†’ è§£é‡ŠæŒ‡å®šIPæœåŠ¡ï¼ˆç”¨ä¸åŒåœ°åŒºå…¼èŒå°ä¼™ä¼´çš„IPï¼‰"
        elif 'aiåˆ·' in customer_message.lower():
            user_prompt += "â†’ ç®€å•å›ç­”ä¸æ˜¯AIåˆ·çš„ï¼Œç„¶åå•ç‹¬è¯¢é—®å…¶ä»–éœ€æ±‚"
        elif re.search(r'æŒ‡å®šip.*(\d+)', customer_message.lower()) or re.search(r'(\d+).*æŒ‡å®šip',
                                                                                customer_message.lower()):
            user_prompt += "â†’ ç¡®è®¤æŒ‡å®šIPä»£å¡«æœåŠ¡å’Œä»·æ ¼ï¼Œè¯¢é—®å…¶ä»–éœ€æ±‚"
        elif 'è¿˜æœ‰ä»€ä¹ˆ' in customer_message:
            user_prompt += "â†’ å®¢æˆ·è¿˜åœ¨äº†è§£ï¼Œç®€å•ä»‹ç»åˆ†ææœåŠ¡"
        elif 'æè¿°å’Œä¿¡æ•ˆåº¦' in customer_message:
            user_prompt += "â†’ ç¡®è®¤åˆ†ææœåŠ¡ï¼Œè®¡ç®—åŒ…å«æ‰€æœ‰æœåŠ¡çš„æ€»ä»·"
        elif (not self.conversation_state.customer_still_asking and
              self.conversation_state.additional_services_asked and
              self.order_manager.total_price > 0):
            user_prompt += "â†’ å®¢æˆ·æ²¡æœ‰ç–‘é—®äº†ï¼Œè®¡ç®—æ€»ä»·å¹¶å¼•å¯¼ä»˜æ¬¾"
        else:
            user_prompt += "â†’ æ ¹æ®å®¢æˆ·æ¶ˆæ¯è‡ªç„¶å›å¤"

        user_prompt += """

ç‰¹åˆ«æ³¨æ„:
1. ä¸¥æ ¼æŒ‰ç…§æµç¨‹é¡ºåºï¼Œä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤
2. ç»Ÿä¸€ä½¿ç”¨"æ‚¨"ç§°å‘¼å®¢æˆ·
3. å®¢æˆ·è¿˜åœ¨å’¨è¯¢æ—¶ä¸è¦æ€¥äºå‚¬å•
4. è®¡ç®—æ€»ä»·æ—¶å¿…é¡»åŒ…å«æ‰€æœ‰å·²ç¡®è®¤çš„æœåŠ¡ï¼ˆé—®å·è®¾è®¡+ä»£å¡«+åˆ†æï¼‰
5. å›å¤è¦åˆ†å¼€å‘é€ï¼Œä¸è¦ä¸€æ¬¡è¯´å¤ªå¤šå†…å®¹
6. ä¸è¦ä¸»åŠ¨ä»‹ç»è‡ªå·±æ˜¯åšä»€ä¹ˆçš„
7. è¯­æ°”æ¸©å’Œå‹å¥½ï¼Œä¸è¦è¿‡åº¦çƒ­æƒ…
8. æŒ‡å®šIPè¯´æ˜ï¼šç”¨ä¸åŒåœ°åŒºå…¼èŒå°ä¼™ä¼´çš„IPåœ°å€

ç›´æ¥ç»™å‡ºä½ çš„å›å¤ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚è¯­æ°”è¦è‡ªç„¶æ¸©å’Œï¼Œå›å¤è¦ç®€æ´ï¼
"""

        return user_prompt


# ==================== å¯¹è¯ç®¡ç†å™¨ ====================
class ConversationManager:
    """å¯¹è¯ç®¡ç†å™¨"""

    def __init__(self):
        self.conversation_history = []
        self.customer_info = {}

    def add_message(self, role, message):
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²"""
        self.conversation_history.append({
            'role': role,
            'message': message,
            'timestamp': time.time()
        })

        if role == 'å®¢æˆ·':
            self._analyze_customer_message(message)

    def _analyze_customer_message(self, message):
        """åˆ†æå®¢æˆ·æ¶ˆæ¯ï¼Œæå–ä¿¡æ¯"""
        msg_lower = message.lower()

        # æå–åŸºæœ¬ä¿¡æ¯
        if 'é—®å·è®¾è®¡' in message or 'è®¾è®¡' in message:
            self.customer_info['service_type'] = 'é—®å·è®¾è®¡'
        elif 'æ•°æ®åˆ†æ' in message or 'åˆ†æ' in message:
            self.customer_info['service_type'] = 'æ•°æ®åˆ†æ'
        elif 'ä»£å¡«' in message:
            self.customer_info['service_type'] = 'ä»£å¡«'

        # æå–é¢˜ç›®æ•°é‡
        numbers = re.findall(r'(\d+)', message)
        if numbers and any(word in msg_lower for word in ['é¢˜', 'ä¸ª', 'é“']):
            self.customer_info['é¢˜ç›®æ•°é‡'] = int(numbers[0])

        # æå–ç ”ç©¶ä¿¡æ¯
        if 'åŒ–å¦†å“' in message:
            self.customer_info['ç ”ç©¶é¢†åŸŸ'] = 'åŒ–å¦†å“'
        if 'è¥é”€' in message:
            self.customer_info['ç ”ç©¶æ–¹æ³•'] = 'è¥é”€'

    def get_conversation_history(self):
        """è·å–å¯¹è¯å†å²"""
        return self.conversation_history

    def get_customer_info(self):
        """è·å–å®¢æˆ·ä¿¡æ¯"""
        return self.customer_info


# ==================== é—²é±¼èŠå¤©åˆ—è¡¨ç›‘æ§å™¨ ====================
class XianyuChatListMonitor:
    """é—²é±¼èŠå¤©åˆ—è¡¨ç›‘æ§å™¨"""

    def __init__(self, driver, wait):
        self.driver = driver
        self.wait = wait
        self.last_chat_items = []
        self.new_message_indicators = [
            '.conversation-item--JReyg97P',  # èŠå¤©é¡¹
            '.conversation-item-active--H2KX6Pb4',  # æ¿€æ´»çš„èŠå¤©é¡¹
            '[class*="conversation-item"]',  # é€šç”¨èŠå¤©é¡¹
            '[class*="chat-item"]'  # å¯èƒ½çš„èŠå¤©é¡¹
        ]

    def get_chat_list(self):
        """è·å–èŠå¤©åˆ—è¡¨"""
        try:
            chat_items = []

            # å°è¯•å¤šç§é€‰æ‹©å™¨è·å–èŠå¤©åˆ—è¡¨
            selectors = [
                '.conversation-item--JReyg97P',
                '.conversation-list--jDBLEMex .conversation-item--JReyg97P',
                '[class*="conversation-item"]',
                '[class*="chat-item"]'
            ]

            for selector in selectors:
                try:
                    elements = self.driver.find_elements(By.CSS_SELECTOR, selector)
                    if elements:
                        print(f"ğŸ“‹ æ‰¾åˆ° {len(elements)} ä¸ªèŠå¤©é¡¹ï¼ˆé€‰æ‹©å™¨: {selector}ï¼‰")

                        for i, element in enumerate(elements):
                            try:
                                # è·å–èŠå¤©å¯¹è±¡åç§°
                                name_element = element.find_element(By.CSS_SELECTOR,
                                                                    '.text-container--y8mm9USY, [class*="chat-name"], [class*="contact-name"]')
                                name = name_element.text.strip().split('\n')[0] if name_element else f"ç”¨æˆ·{i + 1}"

                                # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯æŒ‡ç¤ºå™¨
                                has_new_message = self._check_new_message_indicator(element)

                                # è·å–æœ€åæ¶ˆæ¯æ—¶é—´ï¼ˆå¦‚æœæœ‰ï¼‰
                                time_element = element.find_element(By.CSS_SELECTOR,
                                                                    '[class*="time"], [class*="timestamp"]')
                                last_time = time_element.text.strip() if time_element else ""

                                chat_items.append({
                                    'element': element,
                                    'name': name,
                                    'has_new_message': has_new_message,
                                    'last_time': last_time,
                                    'index': i
                                })

                            except Exception as e:
                                # å¦‚æœæ— æ³•è·å–è¯¦ç»†ä¿¡æ¯ï¼Œè‡³å°‘è®°å½•å…ƒç´ 
                                chat_items.append({
                                    'element': element,
                                    'name': f"èŠå¤©{i + 1}",
                                    'has_new_message': False,
                                    'last_time': "",
                                    'index': i
                                })
                        break

                except Exception as e:
                    continue

            return chat_items

        except Exception as e:
            print(f"âŒ è·å–èŠå¤©åˆ—è¡¨å¤±è´¥: {e}")
            return []

    def _check_new_message_indicator(self, chat_element):
        """æ£€æŸ¥èŠå¤©é¡¹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯æŒ‡ç¤ºå™¨"""
        try:
            # æ£€æŸ¥å„ç§å¯èƒ½çš„æ–°æ¶ˆæ¯æŒ‡ç¤ºå™¨
            indicators = [
                '.ant-badge',  # badgeæŒ‡ç¤ºå™¨
                '[class*="badge"]',  # é€šç”¨badge
                '[class*="unread"]',  # æœªè¯»æ ‡è¯†
                '[class*="new"]',  # æ–°æ¶ˆæ¯æ ‡è¯†
                '.red-dot',  # çº¢ç‚¹
                '[class*="dot"]'  # ç‚¹çŠ¶æŒ‡ç¤ºå™¨
            ]

            for indicator in indicators:
                try:
                    badge_element = chat_element.find_element(By.CSS_SELECTOR, indicator)
                    if badge_element and badge_element.is_displayed():
                        return True
                except:
                    continue

            # æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»çš„èŠå¤©ï¼ˆå¯èƒ½è¡¨ç¤ºæœ‰æ–°æ¶ˆæ¯ï¼‰
            class_attr = chat_element.get_attribute('class') or ''
            if 'active' in class_attr.lower():
                return True

            return False

        except Exception as e:
            return False

    def find_new_messages(self):
        """æŸ¥æ‰¾æœ‰æ–°æ¶ˆæ¯çš„èŠå¤©"""
        try:
            current_chat_items = self.get_chat_list()
            new_message_chats = []

            for chat_item in current_chat_items:
                if chat_item['has_new_message']:
                    new_message_chats.append(chat_item)
                    print(f"ğŸ”” å‘ç°æ–°æ¶ˆæ¯: {chat_item['name']}")

            return new_message_chats

        except Exception as e:
            print(f"âŒ æŸ¥æ‰¾æ–°æ¶ˆæ¯å¤±è´¥: {e}")
            return []

    def click_chat_item(self, chat_item):
        """ç‚¹å‡»èŠå¤©é¡¹è¿›å…¥å¯¹è¯"""
        try:
            element = chat_item['element']

            # ä½¿ç”¨JavaScriptç‚¹å‡»ï¼Œæ›´å¯é 
            self.driver.execute_script("arguments[0].click();", element)

            # ç­‰å¾…é¡µé¢åŠ è½½
            time.sleep(2)

            print(f"âœ… å·²ç‚¹å‡»è¿›å…¥ä¸ {chat_item['name']} çš„å¯¹è¯")
            return True

        except Exception as e:
            print(f"âŒ ç‚¹å‡»èŠå¤©é¡¹å¤±è´¥: {e}")
            return False


# ==================== é—²é±¼è‡ªåŠ¨åŒ–æœºå™¨äººï¼ˆå¢å¼ºç‰ˆï¼‰ ====================
class XianyuAutomationBot:
    """é—²é±¼è‡ªåŠ¨åŒ–æœºå™¨äººï¼ˆå¢å¼ºç‰ˆï¼‰"""

    def __init__(self, deepseek_generator, conversation_manager):
        self.deepseek_generator = deepseek_generator
        self.conversation_manager = conversation_manager
        self.driver = None
        self.wait = None
        self.running = False
        self.last_message_count = 0
        self.current_chat_name = ""
        self.processed_messages = set()  # è®°å½•å·²å¤„ç†çš„æ¶ˆæ¯
        self.chat_monitor = None
        self.current_conversation_id = None
        self.pending_messages = []  # å¾…å‘é€çš„æ¶ˆæ¯é˜Ÿåˆ—

    def setup_driver(self):
        """è®¾ç½®Chromeæµè§ˆå™¨é©±åŠ¨"""
        print("ğŸŒ æ­£åœ¨è®¾ç½®Chromeæµè§ˆå™¨...")

        chrome_options = Options()
        chrome_options.add_argument("--disable-blink-features=AutomationControlled")
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        chrome_options.add_argument("--disable-extensions")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")

        try:
            self.driver = webdriver.Chrome(options=chrome_options)
            self.driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
            self.wait = WebDriverWait(self.driver, 10)

            # åˆå§‹åŒ–èŠå¤©åˆ—è¡¨ç›‘æ§å™¨
            self.chat_monitor = XianyuChatListMonitor(self.driver, self.wait)

            print("âœ… Chromeæµè§ˆå™¨è®¾ç½®æˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ Chromeæµè§ˆå™¨è®¾ç½®å¤±è´¥: {e}")
            return False

    def open_xianyu(self):
        """æ‰“å¼€é—²é±¼èŠå¤©é¡µé¢"""
        print("ğŸŸ æ­£åœ¨æ‰“å¼€é—²é±¼èŠå¤©é¡µé¢...")
        try:
            self.driver.get("https://www.goofish.com/im")
            print("âœ… é—²é±¼é¡µé¢å·²æ‰“å¼€ï¼Œè¯·æ‰‹åŠ¨ç™»å½•...")
            return True
        except Exception as e:
            print(f"âŒ æ‰“å¼€é—²é±¼é¡µé¢å¤±è´¥: {e}")
            return False

    def wait_for_spacebar(self):
        """ç­‰å¾…ç”¨æˆ·æŒ‰ç©ºæ ¼é”®"""
        print("âŒ¨ï¸ è¯·ç™»å½•å®ŒæˆåæŒ‰ç©ºæ ¼é”®å¼€å§‹è‡ªåŠ¨å›å¤...")

        def on_space():
            print("ğŸš€ æ£€æµ‹åˆ°ç©ºæ ¼é”®ï¼Œå¼€å§‹è‡ªåŠ¨æ¥ç®¡é—²é±¼...")
            self.running = True
            return False  # åœæ­¢ç›‘å¬

        keyboard.wait('space')
        self.running = True
        print("ğŸ¤– é—²é±¼è‡ªåŠ¨å›å¤å·²å¯åŠ¨ï¼")

    def get_chat_messages(self):
        """è·å–å½“å‰èŠå¤©çš„æ¶ˆæ¯"""
        try:
            # å°è¯•å¤šç§å¯èƒ½çš„æ¶ˆæ¯é€‰æ‹©å™¨
            message_selectors = [
                ".message-row--pIWaXNhZ",
                ".message-content--kBUbolyy",
                ".msg-dx-content--UtV9jReL",
                "[class*='message']",
                "[class*='msg-dx']"
            ]

            messages = []
            for selector in message_selectors:
                try:
                    elements = self.driver.find_elements(By.CSS_SELECTOR, selector)
                    if elements:
                        print(f"ğŸ“ æ‰¾åˆ° {len(elements)} æ¡æ¶ˆæ¯ï¼ˆé€‰æ‹©å™¨: {selector}ï¼‰")
                        for element in elements:
                            try:
                                text = element.get_attribute('textContent') or element.text
                                if text and text.strip():
                                    # åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯
                                    is_own = self._is_own_message(element)
                                    messages.append({
                                        'text': text.strip(),
                                        'is_own': is_own,
                                        'element': element
                                    })
                            except Exception as e:
                                continue
                        break
                except Exception as e:
                    continue

            return messages
        except Exception as e:
            print(f"âŒ è·å–æ¶ˆæ¯å¤±è´¥: {e}")
            return []

    def _is_own_message(self, element):
        """åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯"""
        try:
            # æ£€æŸ¥å…ƒç´ çš„classå±æ€§
            class_attr = element.get_attribute('class') or ''

            # æ ¹æ®åˆ†æçš„ç»“æœï¼ŒåŒ…å«è¿™äº›classçš„å¯èƒ½æ˜¯è‡ªå·±å‘é€çš„
            own_indicators = [
                'msg-dx-button-text--dtC59Vus',
                'message-text-right',
                'msg-right',
                'own-message'
            ]

            # åŒ…å«è¿™äº›classçš„å¯èƒ½æ˜¯å¯¹æ–¹å‘é€çš„
            other_indicators = [
                'msg-text-left--fqg7TStL',
                'msg-dx-content--UtV9jReL',
                'message-text-left',
                'msg-left'
            ]

            for indicator in own_indicators:
                if indicator in class_attr:
                    return True

            for indicator in other_indicators:
                if indicator in class_attr:
                    return False

            # å¦‚æœæ— æ³•é€šè¿‡classåˆ¤æ–­ï¼Œå°è¯•é€šè¿‡ä½ç½®åˆ¤æ–­
            # æ£€æŸ¥å…ƒç´ çš„çˆ¶å…ƒç´ æˆ–ç¥–å…ˆå…ƒç´ 
            try:
                parent = element.find_element(By.XPATH, '..')
                parent_class = parent.get_attribute('class') or ''

                if 'right' in parent_class.lower():
                    return True
                elif 'left' in parent_class.lower():
                    return False
            except:
                pass

            # é»˜è®¤è®¤ä¸ºä¸æ˜¯è‡ªå·±çš„æ¶ˆæ¯
            return False

        except Exception as e:
            return False


def get_latest_other_message(self):
    """è·å–æœ€æ–°çš„å¯¹æ–¹æ¶ˆæ¯"""
    messages = self.get_chat_messages()

    # è¿‡æ»¤å‡ºå¯¹æ–¹å‘é€çš„æ¶ˆæ¯
    other_messages = [msg for msg in messages if not msg['is_own']]

    if other_messages:
        latest = other_messages[-1]
        message_text = latest['text']

        # ç”Ÿæˆæ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦
        message_id = f"{self.current_chat_name}_{hash(message_text)}_{len(other_messages)}"

        # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡è¿™æ¡æ¶ˆæ¯
        if message_id not in self.processed_messages:
            self.processed_messages.add(message_id)
            return message_text

    return None


def send_message(self, message):
    """å‘é€æ¶ˆæ¯åˆ°é—²é±¼ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰"""
    try:
        print(f"ğŸ“¤ å‡†å¤‡å‘é€æ¶ˆæ¯: {message[:30]}...")

        # æŸ¥æ‰¾è¾“å…¥æ¡†çš„å¤šç§å¯èƒ½é€‰æ‹©å™¨
        input_selectors = [
            "textarea.ant-input",
            ".ant-input.ant-input-outlined",
            "textarea[class*='textarea']",
            "textarea.textarea-no-border--cIId06_i",
            "textarea",
            "[contenteditable='true']"
        ]

        input_element = None
        for selector in input_selectors:
            try:
                input_element = self.wait.until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, selector))
                )
                if input_element and input_element.is_displayed() and input_element.is_enabled():
                    print(f"âœ… æ‰¾åˆ°è¾“å…¥æ¡†: {selector}")
                    break
            except:
                continue

        if not input_element:
            print("âŒ æœªæ‰¾åˆ°å¯ç”¨çš„è¾“å…¥æ¡†")
            return False

        # æ¸…ç©ºè¾“å…¥æ¡†
        try:
            input_element.clear()
            time.sleep(0.5)
        except:
            # å¦‚æœclear()å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨Ctrl+A + Delete
            input_element.send_keys(Keys.CONTROL + "a")
            input_element.send_keys(Keys.DELETE)
            time.sleep(0.5)

        # è¾“å…¥æ¶ˆæ¯
        input_element.send_keys(message)
        time.sleep(1)  # ç­‰å¾…è¾“å…¥å®Œæˆ

        print(f"âœï¸ æ¶ˆæ¯å·²è¾“å…¥åˆ°è¾“å…¥æ¡†")

        # æŸ¥æ‰¾å¹¶ç‚¹å‡»å‘é€æŒ‰é’®
        send_selectors = [
            ".sendbox--A9eGQCY5",
            ".sendbox-bottom--O2c5fyIe",
            "[class*='sendbox']",
            "button[type='submit']",
            "div:contains('å‘é€')",
            "div:contains('å‘ é€')",
            ".send-button",
            "[class*='send-btn']"
        ]

        send_button = None
        for selector in send_selectors:
            try:
                elements = self.driver.find_elements(By.CSS_SELECTOR, selector)
                for element in elements:
                    if element.is_displayed() and element.is_enabled():
                        # æ£€æŸ¥å…ƒç´ æ–‡æœ¬æ˜¯å¦åŒ…å«"å‘é€"ç›¸å…³è¯æ±‡
                        element_text = element.text.strip()
                        if any(word in element_text for word in ['å‘é€', 'å‘ é€', 'Send', 'send']):
                            send_button = element
                            print(f"âœ… æ‰¾åˆ°å‘é€æŒ‰é’®: {selector} - {element_text}")
                            break
                if send_button:
                    break
            except Exception as e:
                continue

        # å°è¯•ç‚¹å‡»å‘é€æŒ‰é’®
        if send_button:
            try:
                # ä½¿ç”¨JavaScriptç‚¹å‡»ï¼Œæ›´å¯é 
                self.driver.execute_script("arguments[0].click();", send_button)
                print(f"ğŸ”˜ å·²ç‚¹å‡»å‘é€æŒ‰é’®")
                time.sleep(1)
            except Exception as e:
                print(f"âš ï¸ JavaScriptç‚¹å‡»å¤±è´¥ï¼Œå°è¯•ActionChains: {e}")
                try:
                    ActionChains(self.driver).move_to_element(send_button).click().perform()
                    print(f"ğŸ”˜ ActionChainsç‚¹å‡»æˆåŠŸ")
                    time.sleep(1)
                except Exception as e2:
                    print(f"âš ï¸ ActionChainsä¹Ÿå¤±è´¥ï¼Œå°è¯•ç›´æ¥ç‚¹å‡»: {e2}")
                    send_button.click()
                    time.sleep(1)
        else:
            # å¦‚æœæ‰¾ä¸åˆ°å‘é€æŒ‰é’®ï¼Œå°è¯•æŒ‰å›è½¦é”®
            print("âš ï¸ æœªæ‰¾åˆ°å‘é€æŒ‰é’®ï¼Œå°è¯•æŒ‰å›è½¦é”®å‘é€")
            input_element.send_keys(Keys.RETURN)
            time.sleep(1)

        # éªŒè¯æ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸ
        time.sleep(2)  # ç­‰å¾…æ¶ˆæ¯å‘é€

        # æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦è¢«æ¸…ç©ºï¼ˆé€šå¸¸è¡¨ç¤ºå‘é€æˆåŠŸï¼‰
        try:
            current_value = input_element.get_attribute('value') or input_element.text
            if not current_value.strip():
                print(f"âœ… æ¶ˆæ¯å‘é€æˆåŠŸ: {message[:50]}...")
                return True
            else:
                print(f"âš ï¸ è¾“å…¥æ¡†æœªè¢«æ¸…ç©ºï¼Œå¯èƒ½å‘é€å¤±è´¥")
                # æ‰‹åŠ¨æ¸…ç©ºè¾“å…¥æ¡†
                input_element.clear()
                return False
        except:
            # å¦‚æœæ— æ³•æ£€æŸ¥è¾“å…¥æ¡†çŠ¶æ€ï¼Œå‡è®¾å‘é€æˆåŠŸ
            print(f"âœ… æ¶ˆæ¯å·²å‘é€: {message[:50]}...")
            return True

    except Exception as e:
        print(f"âŒ å‘é€æ¶ˆæ¯å¤±è´¥: {e}")
        return False


def send_multiple_messages(self, messages):
    """å‘é€å¤šæ¡æ¶ˆæ¯ï¼ˆé˜Ÿåˆ—å¤„ç†ï¼‰"""
    """å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œç¡®ä¿æ¯æ¡æ¶ˆæ¯éƒ½èƒ½æ­£ç¡®å‘é€"""
    success_count = 0

    for i, message in enumerate(messages):
        try:
            print(f"ğŸ“¤ å‘é€ç¬¬ {i + 1}/{len(messages)} æ¡æ¶ˆæ¯...")

            # å‘é€æ¶ˆæ¯
            if self.send_message(message):
                success_count += 1
                self.conversation_manager.add_message('æˆ‘', message)

                # éšæœºå»¶è¿Ÿï¼Œæ¨¡æ‹Ÿäººå·¥å‘é€é—´éš”
                if i < len(messages) - 1:  # ä¸æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯
                    delay = random.uniform(2, 5)
                    print(f"â° ç­‰å¾… {delay:.1f} ç§’åå‘é€ä¸‹ä¸€æ¡...")
                    time.sleep(delay)
            else:
                print(f"âŒ ç¬¬ {i + 1} æ¡æ¶ˆæ¯å‘é€å¤±è´¥")

        except Exception as e:
            print(f"âŒ å‘é€ç¬¬ {i + 1} æ¡æ¶ˆæ¯æ—¶å‡ºé”™: {e}")

    print(f"ğŸ“Š å‘é€å®Œæˆ: {success_count}/{len(messages)} æ¡æ¶ˆæ¯æˆåŠŸ")
    return success_count == len(messages)


def get_current_chat_name(self):
    """è·å–å½“å‰èŠå¤©å¯¹è±¡åç§°"""
    try:
        # å°è¯•å¤šç§å¯èƒ½çš„é€‰æ‹©å™¨è·å–èŠå¤©å¯¹è±¡åç§°
        name_selectors = [
            ".message-topbar--uzL8Czfo",
            "[class*='chat-name']",
            "[class*='contact-name']",
            ".conversation-title",
            ".text-container--y8mm9USY"
        ]

        for selector in name_selectors:
            try:
                element = self.driver.find_element(By.CSS_SELECTOR, selector)
                name = element.text.strip()
                if name and len(name) > 0:
                    # æå–å®é™…çš„ç”¨æˆ·åï¼ˆå»æ‰å¤šä½™ä¿¡æ¯ï¼‰
                    name = name.split('\n')[0].split('(')[0].strip()
                    if len(name) > 1:  # ç¡®ä¿ä¸æ˜¯å•ä¸ªå­—ç¬¦
                        return name
            except:
                continue

        return "æœªçŸ¥ç”¨æˆ·"
    except Exception as e:
        return "æœªçŸ¥ç”¨æˆ·"


def monitor_chat_list(self):
    """ç›‘æ§èŠå¤©åˆ—è¡¨ï¼Œè‡ªåŠ¨ç‚¹å‡»æœ‰æ–°æ¶ˆæ¯çš„èŠå¤©"""
    try:
        print("ğŸ‘ï¸ å¼€å§‹ç›‘æ§èŠå¤©åˆ—è¡¨...")

        while self.running:
            try:
                # æŸ¥æ‰¾æœ‰æ–°æ¶ˆæ¯çš„èŠå¤©
                new_message_chats = self.chat_monitor.find_new_messages()

                if new_message_chats:
                    for chat_item in new_message_chats:
                        print(f"ğŸ”” å‘ç°æ–°æ¶ˆæ¯æ¥è‡ª: {chat_item['name']}")

                        # ç‚¹å‡»è¿›å…¥èŠå¤©
                        if self.chat_monitor.click_chat_item(chat_item):
                            # æ›´æ–°å½“å‰èŠå¤©ä¿¡æ¯
                            self.current_chat_name = chat_item['name']
                            self.current_conversation_id = f"{chat_item['name']}_{time.time()}"

                            # ç­‰å¾…é¡µé¢åŠ è½½
                            time.sleep(3)

                            # å¤„ç†è¿™ä¸ªèŠå¤©ä¸­çš„æ–°æ¶ˆæ¯
                            self.handle_current_chat_messages()

                            # å¤„ç†å®Œåç¨ä½œä¼‘æ¯
                            time.sleep(2)

                # ç›‘æ§é—´éš”
                time.sleep(random.uniform(5, 10))

            except Exception as e:
                print(f"âŒ ç›‘æ§èŠå¤©åˆ—è¡¨å‡ºé”™: {e}")
                time.sleep(5)

    except Exception as e:
        print(f"âŒ èŠå¤©åˆ—è¡¨ç›‘æ§å¤±è´¥: {e}")


def handle_current_chat_messages(self):
    """å¤„ç†å½“å‰èŠå¤©ä¸­çš„æ¶ˆæ¯"""
    try:
        # è·å–æœ€æ–°çš„å¯¹æ–¹æ¶ˆæ¯
        latest_message = self.get_latest_other_message()

        if latest_message:
            print(f"ğŸ“¨ æ”¶åˆ°æ¥è‡ª {self.current_chat_name} çš„æ¶ˆæ¯: {latest_message}")

            # æ·»åŠ åˆ°å¯¹è¯å†å²
            self.conversation_manager.add_message('å®¢æˆ·', latest_message)

            # ç”Ÿæˆå›å¤
            print("ğŸ¤– æ­£åœ¨ç”Ÿæˆæ™ºèƒ½å›å¤...")
            response_result = self.deepseek_generator.generate_response(
                latest_message,
                self.conversation_manager.get_conversation_history()
            )

            response_text = response_result['response']
            method = response_result['method']
            is_template = response_result.get('is_template', False)

            print(f"ğŸ’­ ç”Ÿæˆå›å¤ ({method}): {response_text[:50]}...")

            # æ£€æŸ¥æ˜¯å¦æ˜¯å›ºå®šè¯æœ¯æ¨¡æ¿
            if is_template:
                # æ¨¡æ¿æ¶ˆæ¯ç›´æ¥å‘é€ï¼Œä¸åˆ†æ®µ
                delay = random.uniform(2, 5)
                print(f"â° ç­‰å¾… {delay:.1f} ç§’åå‘é€æ¨¡æ¿å›å¤...")
                time.sleep(delay)

                if self.send_message(response_text):
                    self.conversation_manager.add_message('æˆ‘', response_text)
                    print(f"ğŸ“¤ æ¨¡æ¿å›å¤å·²å‘é€")
            else:
                # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†æ®µå‘é€
                if self._should_split_response(response_text):
                    parts = self._split_response(response_text)
                    print(f"ğŸ“ å›å¤å°†åˆ†ä¸º {len(parts)} æ®µå‘é€")
                    self.send_multiple_messages(parts)
                else:
                    # æ·»åŠ éšæœºå»¶è¿Ÿæ¨¡æ‹Ÿäººå·¥å›å¤
                    delay = random.uniform(3, 8)
                    print(f"â° ç­‰å¾… {delay:.1f} ç§’åå›å¤...")
                    time.sleep(delay)

                    if self.send_message(response_text):
                        self.conversation_manager.add_message('æˆ‘', response_text)

    except Exception as e:
        print(f"âŒ å¤„ç†å½“å‰èŠå¤©æ¶ˆæ¯å¤±è´¥: {e}")


def monitor_and_reply(self):
    """ç›‘æ§æ¶ˆæ¯å¹¶è‡ªåŠ¨å›å¤ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    print("ğŸ‘€ å¼€å§‹ç›‘æ§é—²é±¼æ¶ˆæ¯...")

    # å¯åŠ¨èŠå¤©åˆ—è¡¨ç›‘æ§çº¿ç¨‹
    chat_list_thread = threading.Thread(target=self.monitor_chat_list, daemon=True)
    chat_list_thread.start()

    # ä¸»å¾ªç¯ï¼šç›‘æ§å½“å‰èŠå¤©
    while self.running:
        try:
            # æ›´æ–°å½“å‰èŠå¤©å¯¹è±¡
            self.current_chat_name = self.get_current_chat_name()

            # å¤„ç†å½“å‰èŠå¤©çš„æ–°æ¶ˆæ¯
            self.handle_current_chat_messages()

            # æ£€æŸ¥é¢‘ç‡
            time.sleep(random.uniform(3, 6))

        except KeyboardInterrupt:
            print("\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ï¼Œåœæ­¢ç›‘æ§")
            self.running = False
            break
        except Exception as e:
            print(f"âŒ ç›‘æ§è¿‡ç¨‹å‡ºé”™: {e}")
            time.sleep(5)  # å‡ºé”™åç­‰å¾…5ç§’å†ç»§ç»­


def _should_split_response(self, response):
    """åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†æ®µå‘é€"""
    # å¦‚æœå›å¤å¾ˆé•¿æˆ–åŒ…å«å¤šä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œå°±åˆ†æ®µå‘é€
    return (len(response) > 100 or
            response.count('\n') > 2 or
            response.count('ã€‚') > 3)


def _split_response(self, response):
    """åˆ†å‰²å›å¤ä¸ºå¤šä¸ªéƒ¨åˆ†"""
    parts = []

    # æŒ‰æ¢è¡Œç¬¦åˆ†å‰²
    lines = response.split('\n')
    current_part = ""

    for line in lines:
        line = line.strip()
        if not line:
            continue

        if len(current_part + line) > 80:
            if current_part:
                parts.append(current_part.strip())
            current_part = line
        else:
            current_part += ("\n" if current_part else "") + line

    if current_part:
        parts.append(current_part.strip())

    # å¦‚æœæ²¡æœ‰æˆåŠŸåˆ†å‰²ï¼ŒæŒ‰å¥å­åˆ†å‰²
    if len(parts) <= 1:
        sentences = re.split(r'[ã€‚ï¼ï¼Ÿ]', response)
        parts = []
        current_part = ""

        for sentence in sentences:
            sentence = sentence.strip()
            if not sentence:
                continue

            if len(current_part + sentence) > 60:
                if current_part:
                    parts.append(current_part.strip() + "ã€‚")
                current_part = sentence
            else:
                current_part += sentence + "ã€‚"

        if current_part:
            parts.append(current_part.strip())

    return parts if len(parts) > 1 else [response]


def stop(self):
    """åœæ­¢è‡ªåŠ¨å›å¤"""
    print("ğŸ›‘ æ­£åœ¨åœæ­¢é—²é±¼è‡ªåŠ¨å›å¤...")
    self.running = False
    if self.driver:
        self.driver.quit()
        print("âœ… æµè§ˆå™¨å·²å…³é—­")


def run(self):
    """è¿è¡Œé—²é±¼è‡ªåŠ¨åŒ–æœºå™¨äºº"""
    try:
        # 1. è®¾ç½®æµè§ˆå™¨
        if not self.setup_driver():
            return False

        # 2. æ‰“å¼€é—²é±¼é¡µé¢
        if not self.open_xianyu():
            return False

        # 3. ç­‰å¾…ç”¨æˆ·ç™»å½•å¹¶æŒ‰ç©ºæ ¼
        self.wait_for_spacebar()

        # 4. å¼€å§‹ç›‘æ§å’Œè‡ªåŠ¨å›å¤
        self.monitor_and_reply()

    except KeyboardInterrupt:
        print("\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"âŒ è¿è¡Œå‡ºé”™: {e}")
    finally:
        self.stop()


# ==================== ä¸»ç¨‹åº ====================
class DeepSeekChatbotTrainer:
    def __init__(self, tex_dir, deepseek_api_key):
        self.tex_dir = tex_dir
        self.deepseek_api_key = deepseek_api_key
        self.learned_patterns = {}
        self.deepseek_generator = None
        self.conversation_manager = None
        self.xianyu_bot = None

    def train_and_run(self):
        """è®­ç»ƒå¹¶è¿è¡Œ"""
        print("ğŸš€ å¼€å§‹DeepSeekæ™ºèƒ½èŠå¤©æœºå™¨äººè®­ç»ƒï¼ˆé—²é±¼è‡ªåŠ¨åŒ–å¢å¼ºç‰ˆï¼‰...")
        print("=" * 60)

        # æ­¥éª¤1: ä»èŠå¤©è®°å½•å­¦ä¹ 
        print("ğŸ“ æ­¥éª¤1: ä»çœŸå®èŠå¤©è®°å½•ä¸­æ·±åº¦å­¦ä¹ ...")
        learner = ChatRecordLearner(self.tex_dir)
        self.learned_patterns = learner.learn_from_chat_records()

        # ä¿å­˜å­¦ä¹ ç»“æœ
        with open("learned_patterns_final.json", 'w', encoding='utf-8') as f:
            json.dump(self.learned_patterns, f, ensure_ascii=False, indent=2)
        print("ğŸ’¾ å­¦ä¹ ç»“æœå·²ä¿å­˜åˆ° learned_patterns_final.json")

        # æ­¥éª¤2: åˆå§‹åŒ–æœ€ç»ˆç‰ˆDeepSeekç”Ÿæˆå™¨
        print("\nğŸ¤– æ­¥éª¤2: åˆå§‹åŒ–æœ€ç»ˆç‰ˆDeepSeekæ™ºèƒ½ç”Ÿæˆå™¨...")
        self.deepseek_generator = DeepSeekIntelligentGenerator(self.deepseek_api_key)
        self.deepseek_generator.load_learned_patterns(self.learned_patterns)

        # æ­¥éª¤3: åˆå§‹åŒ–å¯¹è¯ç®¡ç†å™¨
        print("\nğŸ’¬ æ­¥éª¤3: åˆå§‹åŒ–å¯¹è¯ç®¡ç†å™¨...")
        self.conversation_manager = ConversationManager()

        # æ­¥éª¤4: æµ‹è¯•æœ€ç»ˆç³»ç»Ÿ
        print("\nğŸ§ª æ­¥éª¤4: æµ‹è¯•æœ€ç»ˆç³»ç»Ÿ...")
        self.test_final_system()

        # æ­¥éª¤5: å¯åŠ¨é—²é±¼è‡ªåŠ¨åŒ–æœºå™¨äºº
        print("\nğŸŸ æ­¥éª¤5: å¯åŠ¨é—²é±¼è‡ªåŠ¨åŒ–æœºå™¨äºº...")
        self.start_xianyu_automation()

    def test_final_system(self):
        """æµ‹è¯•æœ€ç»ˆç³»ç»Ÿ"""
        test_messages = [
            "ä½ å¥½",
            "é—®å·è®¾è®¡",
            "ä»£å¡«å…è´¹å—"
        ]

        print("æµ‹è¯•æœ€ç»ˆç‰ˆDeepSeekæ™ºèƒ½å›å¤...")
        for msg in test_messages:
            try:
                print(f"  æµ‹è¯•æ¶ˆæ¯: {msg}")
                response_result = self.deepseek_generator.generate_response(msg)
                print(f"  å›å¤: {response_result['response'][:50]}...")
                print(f"  æ–¹å¼: {response_result['method']}")
                print(f"  çŠ¶æ€: {self.deepseek_generator.conversation_state.get_state()}")
                print("-" * 40)
            except Exception as e:
                print(f"  æµ‹è¯•å‡ºé”™: {e}")

    def start_xianyu_automation(self):
        """å¯åŠ¨é—²é±¼è‡ªåŠ¨åŒ–"""
        try:
            print("ğŸ¤– åˆå§‹åŒ–é—²é±¼è‡ªåŠ¨åŒ–æœºå™¨äºº...")
            self.xianyu_bot = XianyuAutomationBot(
                self.deepseek_generator,
                self.conversation_manager
            )

            print("ğŸš€ å¯åŠ¨é—²é±¼è‡ªåŠ¨åŒ–...")
            self.xianyu_bot.run()

        except Exception as e:
            print(f"âŒ å¯åŠ¨é—²é±¼è‡ªåŠ¨åŒ–å¤±è´¥: {e}")


def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¤– DeepSeekæ™ºèƒ½èŠå¤©æœºå™¨äººè®­ç»ƒç³»ç»Ÿï¼ˆé—²é±¼è‡ªåŠ¨åŒ–å¢å¼ºç‰ˆï¼‰")
    print("ğŸ“ ä»çœŸå®èŠå¤©è®°å½•ä¸­å­¦ä¹ é£æ ¼å’Œä¸šåŠ¡è§„åˆ™")
    print("ğŸ¤– DeepSeekæ™ºèƒ½æ€è€ƒï¼Œå®Œå…¨æ¨¡ä»¿çœŸå®å¯¹è¯")
    print("ğŸ—£ï¸ è‡ªç„¶åˆ†å¼€å›å¤ï¼Œä½¿ç”¨'æ‚¨'ç§°å‘¼å®¢æˆ·")
    print("ğŸ“‹ å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼šé—®å€™â†’éœ€æ±‚æ”¶é›†â†’æŠ¥ä»·â†’æ³¨æ„äº‹é¡¹â†’é¢å¤–æœåŠ¡â†’è€å¿ƒè§£ç­”â†’ä»˜æ¬¾")
    print("ğŸš« ä¸æ€¥å‚¬å•ï¼Œå®¢æˆ·æœ‰ç–‘é—®æ—¶è€å¿ƒè§£ç­”ï¼Œåˆ†å¼€å›å¤")
    print("ğŸ’° å‡†ç¡®ä»·æ ¼è®¡ç®—ï¼ŒåŒ…å«æ‰€æœ‰ç¡®è®¤çš„æœåŠ¡")
    print("ğŸ‘¤ çœŸå®ä¸ªäººèº«ä»½ï¼Œä¸ä¸»åŠ¨ä»‹ç»è‡ªå·±")
    print("ğŸ”§ ä»£å¡«è¯´æ˜ï¼šç”¨ä¸åŒåœ°åŒºå…¼èŒå°ä¼™ä¼´çš„IPåœ°å€")
    print("ğŸŸ é—²é±¼è‡ªåŠ¨åŒ–ï¼šå®æ—¶ç›‘æ§èŠå¤©åˆ—è¡¨ï¼Œæ™ºèƒ½è‡ªåŠ¨å›å¤")
    print("ğŸ“¨ æ–°å¢åŠŸèƒ½ï¼šä¸»åŠ¨ç›‘æ§èŠå¤©åˆ—è¡¨ï¼Œè‡ªåŠ¨ç‚¹å‡»æ–°æ¶ˆæ¯")
    print("ğŸ“¤ ä¿®å¤åŠŸèƒ½ï¼šç¡®ä¿æ¯æ¡æ¶ˆæ¯éƒ½èƒ½æ­£ç¡®å‘é€")
    print("ğŸ“ å›ºå®šè¯æœ¯ï¼šé—®å·è®¾è®¡ä½¿ç”¨å®Œæ•´çš„å›ºå®šè¯æœ¯æ¨¡æ¿")
    print("=" * 60)

    # ä»ç¯å¢ƒå˜é‡è·å–APIå¯†é’¥ï¼Œæ›´å®‰å…¨
    TEX_DIR = r"C:\Users\1\Desktop\é—²é±¼"
    DEEPSEEK_API_KEY = os.getenv('DEEPSEEK_API_KEY', "sk-7bcf5415f6bf424a896af80fbe6327e7")

    trainer = DeepSeekChatbotTrainer(TEX_DIR, DEEPSEEK_API_KEY)

    try:
        trainer.train_and_run()
    except KeyboardInterrupt:
        print("\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nâŒ å‡ºé”™: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
